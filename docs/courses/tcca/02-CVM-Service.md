---
title: 云服务器
---

计算服务之云服务器 { #cvm-service }
===================================

云服务器，是云计算环境中的一种重要资源。它们是在物理服务器上虚拟化的独立服务器，可以提供与传统服务器相同的功能，但具有更高的灵活性和可扩展性。云服务器可以快速部署、按需扩展，并且只需为实际使用的资源付费。

---

1. KVM 虚拟化技术
-----------------

### 1.1. 虚拟化技术（Virtualization）

将任何一种形式的资源抽象成另一种形式的技术，都是虚拟化。虚拟化是资源的逻辑表示，不受物理限制的约束。

1.  虚拟化的主要优点：
    
    -   资源共享
    -   成本降低
    -   灵活性高
    -   易于管理
    -   便于维护
    
1.  虚拟化的类型：
    
    -   硬件虚拟化
    -   操作系统虚拟化
    -   网络虚拟化
    -   存储虚拟化
    
1.  虚拟化技术的几个重要概念：
    
    -   Guest OS
    -   Guest Machine
    -   Hypervisor: 

        -   虚拟化软件层/虚拟机监控机 
        -   Virtual Machine Monitor, VMM

    -   Host OS
    -   Host Machine

### 1.2 KVM（Kernel-base Virtual Machine）虚拟化技术

KVM 是一种开源的虚拟化技术，它是基于 Linux 内核的虚拟化基础设置。

1.  KVM 虚拟化技术的发展史：

    -   2006 年：由 Qumranet 公司的工程师首次开发并发布。
    -   2007 年：被合并到 Linux 内核当中。
    -   2008 年：红帽收购 Qumranet。
    -   2009 年：成为多数 Linux 发行版的标准虚拟化组件。
    -   2010 年：成为 OpenStack 等云计算平台的首选虚拟化技术之一。
    -   -> 至今：仍是 Linux 虚拟化领域的主要技术之一。

1.  KVM 虚拟化技术的系统架构：

    -   KVM 需要处理器具有硬件虚拟化支持。
    -   KVM 是 Linux 内核的一部分。
    -   QEMU 负责模拟 CPU、内存、磁盘、网络接口和其他硬件资源，以便虚拟机可以使用这些资源。
 
1.  KVM 虚拟化技术的组件架构：

    -   Guest
    -   KVM
    -   QEMU
    -   Libvirt

1.  KVM 虚拟化技术的原理：

    -   KVM 虚拟化技术之 CPU 虚拟化：
        
        有了现代处理器的虚拟化扩展，如 Intel 的 VT-x 和 AMD 的 AMD-V，KVM 模块可以在 VMX Root mode（根模式，相当于 Ring -1）下运行，虚拟机在 VMX Non-Root mode（非根模式，相当于 Ring 0~3）下运行。这样 VMM 可以直接管理硬件资源，减少了上下文切换的开销。
        
    -   KVM 虚拟化技术之内存虚拟化：
     
        通过硬件辅助的虚拟化技术，如 Intel 的 EPT（Extended Page Table）和 AMD 的 RVI（Rapid Virtualization Indexing，也称为 NPT，Nested Page Table），允许 MMU（虚拟内存单元）直接处理从虚拟地址到宿主物理地址的转换，而不需要进行频繁的软件干预。
    
    -   KVM 虚拟化技术之存储虚拟化：
    
        在 KVM 中，存储虚拟化通过模拟和管理虚拟机的存储资源实现，使得虚拟机能像直接访问物理设备一样使用存储资源。
    
        虚拟机通过**前端驱动（Virtio 前端）**将存储 I/O 请求转换为宿主机可理解的请求，将其发送到宿主机的**后段挂载驱动（Virtio 后端）**，进一步传递给宿主机的存储子系统。这里宿主机的存储资源通过**逻辑卷管理（LVM）**为虚拟机提供存储空间。最后，宿主机的**通用块层**统一调度 I/O 请求，将其转换为对应的块设备操作，**设备驱动层**将这些操作请求转换为特定的硬件命令进行处理。
    
    -   KVM 虚拟化技术之网络虚拟化：
    
        KVM 引入 Virtio 半虚拟化网卡技术，通过一种更直接的方式，让**虚拟机**通过 **Virtio 虚拟网卡**直接和**虚拟化层**进行通信，绕过硬件仿真，减少了模拟的开销。之后虚拟化层将网络流量注入**内核网络栈**（L3~L4, IP/TCP），宿主机内核再通过**内核网桥**（L2, MAC），将流量转发到**物理网卡**，与外部网络通信。
    
    !!! note

        加粗字体的出现顺序与对应层次递进的顺序相同。

1.  KVM 虚拟化的作用：
 
    -   显著提高物理服务器资源的利用率
    -   支持批量部署虚拟机
    -   支持实时快照功能
    -   支持克隆功能
    -   支持在线和离线迁移（用于满足服务等级协议 SLA 的核心手段）
    -   支持资源的动态调整

---

2. 云服务器的相关概念与技术
---------------------------

**地域（Region）**

:   云服务器提供商在全球不同地理位置的数据中心集群。每个地域都是一个独立的地理区域，包含多个数据中心。

**可用区（Availability Zone）**

:   在同一地域内的一个或多个物理数据中心，它们之间通过低延迟的网络连接。每个可用区都设计为相互独立，以确保服务的高可用性。

**机型**

:   云服务提供商提供的一系列具有相似性能特点和设计目的的云服务器类型。

**云盘**

:   基于云计算技术的存储解决方案。
  
    ---

    -   其主要特点和优势包括：弹性扩展、高可用性、随时随地访问、易于管理、成本效益、安全性。
    -   云服务商提供的安全措施：数据加密、访问控制、审计日志等。
    -   常见用途包括：数据备份、文件共享、应用程序存储、大数据分析。
  
**镜像**

:   一种虚拟机模板，它包含了操作系统、应用程序和配置等信息。

**快照**

:   一种数据管理技术，用于在特定时间点捕捉和保存数据的状态。

    ---

    -   主要的两种实现方式：写时复制（Copy-On-Write, COW）、写重定向（Redirect-On-Write, ROW）。

    !!! info

        === "写时复制（COW）详细过程"

            | COW 阶段   | `LBA:[0x1000]` | `LBA:[0x2000]` | 读取目标       |
            | :--------: | :------------: | :------------: | :------------: |
            | 创建快照后 | `Hello`        | 空             | `LBA:[0x1000]` |
            | 修改数据后 | `World`        | `Hello`        | `LBA:[0x1000]` |
            | 备注       |                |                | 不查表         |
        
        === "写重定向（ROW）详细过程"

            | ROW 阶段   | `LBA:[0x1000]` | `LBA:[0x2000]` | 读取目标       |
            | :--------: | :------------: | :------------: | :------------: |
            | 创建快照后 | `Hello`        | 空             | `LBA:[0x1000]` |
            | 修改数据后 | `Hello`        | `World`        | `LBA:[0x2000]` |
            | 备注       |                |                | 查表读取       |

**弹性网卡**

:   一种可附加到云服务器上的虚拟网络接口，它允许使用者在云环境中灵活地管理和配置网络。

    ---

    -   主要特点包括：灵活性、可扩展性、高可用性、安全隔离性、简化管理。
    -   使用场景包括：多网络环境、负载均衡、故障转移。

**安全组**

:   一种虚拟防火墙，用于控制一组云服务器的网络通信权限。

    ---

    -   主要特点和优势：状态性、组内共享、粒度控制、易于管理、内置安全。
    -   常见用途包括：限制访问、隔离服务、实现网络分段。

**热迁移**

:   一种在**不关闭**虚拟机的情况下，将其从一个物理主机迁移到另一个物理主机的技术。
  
    ---

    -   具体流程为：迁移开始时，通过 TOR 交换机建立一个高带宽低延迟的数据传输通道。预拷贝阶段，虚拟机的内存页会逐页复制到目标主机，多次迭代拷贝（复制自上次以来发生过变化的内存页）。这个过程会持续到内存页的变化速率低于一定阈值，或者达到最大迭代次数。预拷贝阶段接近完成时，虚拟机会短暂停止运行，通常在在毫秒级别以内，确保最后一批内存页的复制。然后目标主机接管源主机的计算任务。
    -   得以实现的技术支持： 高校的内存复制算法（如脏页追踪、增量复制）、低延迟网络连接与虚拟化平台的支持（如 KVM、VMware vSphere）。
    -   重要应用价值：实现资源的动态调度和负载均衡、在不影响业务运行的情况下进行服务器的升级和维护。

**冷迁移**

:   一种在**关闭**虚拟机的情况下，将其从一个物理主机迁移到另一个物理主机的技术。

    ---

    -   依赖于以下几个关键因素：虚拟机的状态保存和恢复、高效的文件传输机制、虚拟化平台的支持（如 KVM、VMware vSphere）。
    -   重要应用价值： 硬件的维护和升级、资源优化、数据中心迁移。

**故障迁移**

:   一种保护机制。在监测到服务器故障时，将运行在故障服务器上的虚拟机，自动迁移到正常的服务器上。（在此期间，虚拟机的状态和内存会被保存到云盘共享存储中）。

    ---

    -   依赖于以下几个关键因素：高效的故障检测机制、共享存储系统、虚拟化平台的支持（如 KVM、VMware vSphere）。

**弹性伸缩**

:    一种自动调整计算资源的技术，用于应对不断变化的业务需求。

    ---

    -   重要应用价值：应对突发流量、优化资源利用。

---

3. 云服务器 CVM
---------------
